var Tr=Object.create;var _e=Object.defineProperty,Rr=Object.defineProperties,Ar=Object.getOwnPropertyDescriptor,br=Object.getOwnPropertyDescriptors,xr=Object.getOwnPropertyNames,lt=Object.getOwnPropertySymbols,Pr=Object.getPrototypeOf,ct=Object.prototype.hasOwnProperty,Sr=Object.prototype.propertyIsEnumerable;var ft=(r,e,t)=>e in r?_e(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,f=(r,e)=>{for(var t in e||(e={}))ct.call(e,t)&&ft(r,t,e[t]);if(lt)for(var t of lt(e))Sr.call(e,t)&&ft(r,t,e[t]);return r},Ce=(r,e)=>Rr(r,br(e)),_r=r=>_e(r,"__esModule",{value:!0});var ve=(r=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(r,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):r)(function(r){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+r+'" is not supported')});var w=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Cr=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of xr(e))!ct.call(r,i)&&i!=="default"&&_e(r,i,{get:()=>e[i],enumerable:!(t=Ar(e,i))||t.enumerable});return r},ge=r=>Cr(_r(_e(r!=null?Tr(Pr(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var pt=w((yi,mt)=>{"use strict";function Ke(r){this.message=r}Ke.prototype=new Error,Ke.prototype.name="InvalidCharacterError";var ht=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(r){var e=String(r).replace(/=+$/,"");if(e.length%4==1)throw new Ke("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,i,n=0,s=0,a="";i=e.charAt(s++);~i&&(t=n%4?64*t+i:i,n++%4)?a+=String.fromCharCode(255&t>>(-2*n&6)):0)i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);return a};function Or(r){var e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(t){return decodeURIComponent(ht(t).replace(/(.)/g,function(i,n){var s=n.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}(e)}catch(t){return ht(e)}}function ye(r){this.message=r}function gt(r,e){if(typeof r!="string")throw new ye("Invalid token specified");var t=(e=e||{}).header===!0?0:1;try{return JSON.parse(Or(r.split(".")[t]))}catch(i){throw new ye("Invalid token specified: "+i.message)}}ye.prototype=new Error,ye.prototype.name="InvalidTokenError";var ke=gt;ke.default=gt,ke.InvalidTokenError=ye,mt.exports=ke});var vt=w((Ei,dt)=>{"use strict";var Ir=["ETIMEDOUT","ECONNRESET","EADDRINUSE","ESOCKETTIMEDOUT","ECONNREFUSED","EPIPE","EHOSTUNREACH","EAI_AGAIN"],wr=["ENOTFOUND","ENETUNREACH","UNABLE_TO_GET_ISSUER_CERT","UNABLE_TO_GET_CRL","UNABLE_TO_DECRYPT_CERT_SIGNATURE","UNABLE_TO_DECRYPT_CRL_SIGNATURE","UNABLE_TO_DECODE_ISSUER_PUBLIC_KEY","CERT_SIGNATURE_FAILURE","CRL_SIGNATURE_FAILURE","CERT_NOT_YET_VALID","CERT_HAS_EXPIRED","CRL_NOT_YET_VALID","CRL_HAS_EXPIRED","ERROR_IN_CERT_NOT_BEFORE_FIELD","ERROR_IN_CERT_NOT_AFTER_FIELD","ERROR_IN_CRL_LAST_UPDATE_FIELD","ERROR_IN_CRL_NEXT_UPDATE_FIELD","OUT_OF_MEM","DEPTH_ZERO_SELF_SIGNED_CERT","SELF_SIGNED_CERT_IN_CHAIN","UNABLE_TO_GET_ISSUER_CERT_LOCALLY","UNABLE_TO_VERIFY_LEAF_SIGNATURE","CERT_CHAIN_TOO_LONG","CERT_REVOKED","INVALID_CA","PATH_LENGTH_EXCEEDED","INVALID_PURPOSE","CERT_UNTRUSTED","CERT_REJECTED"];dt.exports=function(r){return!r||!r.code||Ir.indexOf(r.code)!==-1?!0:wr.indexOf(r.code)===-1}});var At=w(z=>{"use strict";Object.defineProperty(z,"__esModule",{value:!0});var Nr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r};z.isNetworkError=ze;z.isRetryableError=Oe;z.isSafeRequestError=Et;z.isIdempotentRequestError=Ye;z.isNetworkOrIdempotentRequestError=He;z.exponentialDelay=Tt;z.default=re;var Dr=vt(),Fr=Vr(Dr);function Vr(r){return r&&r.__esModule?r:{default:r}}var je="axios-retry";function ze(r){return!r.response&&Boolean(r.code)&&r.code!=="ECONNABORTED"&&(0,Fr.default)(r)}var yt=["get","head","options"],Ur=yt.concat(["put","delete"]);function Oe(r){return r.code!=="ECONNABORTED"&&(!r.response||r.response.status>=500&&r.response.status<=599)}function Et(r){return r.config?Oe(r)&&yt.indexOf(r.config.method)!==-1:!1}function Ye(r){return r.config?Oe(r)&&Ur.indexOf(r.config.method)!==-1:!1}function He(r){return ze(r)||Ye(r)}function Lr(){return 0}function Tt(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,e=Math.pow(2,r)*100,t=e*.2*Math.random();return e+t}function Rt(r){var e=r[je]||{};return e.retryCount=e.retryCount||0,r[je]=e,e}function Br(r,e){return Object.assign({},e,r[je])}function qr(r,e){r.defaults.agent===e.agent&&delete e.agent,r.defaults.httpAgent===e.httpAgent&&delete e.httpAgent,r.defaults.httpsAgent===e.httpsAgent&&delete e.httpsAgent}async function Mr(r,e,t,i){var n=t.retryCount<r&&e(i);if((typeof n=="undefined"?"undefined":Nr(n))==="object")try{return await n,!0}catch(s){return!1}return n}function re(r,e){r.interceptors.request.use(function(t){var i=Rt(t);return i.lastRequestTime=Date.now(),t}),r.interceptors.response.use(null,async function(t){var i=t.config;if(!i)return Promise.reject(t);var n=Br(i,e),s=n.retries,a=s===void 0?3:s,u=n.retryCondition,c=u===void 0?He:u,o=n.retryDelay,l=o===void 0?Lr:o,g=n.shouldResetTimeout,R=g===void 0?!1:g,O=Rt(i);if(await Mr(a,c,O,t)){O.retryCount+=1;var S=l(O.retryCount,t);if(qr(r,i),!R&&i.timeout&&O.lastRequestTime){var K=Date.now()-O.lastRequestTime;i.timeout=Math.max(i.timeout-K-S,1)}return i.transformRequest=[function(h){return h}],new Promise(function(h){return setTimeout(function(){return h(r(i))},S)})}return Promise.reject(t)})}re.isNetworkError=ze;re.isSafeRequestError=Et;re.isIdempotentRequestError=Ye;re.isNetworkOrIdempotentRequestError=He;re.exponentialDelay=Tt;re.isRetryableError=Oe});var xt=w((Ri,bt)=>{bt.exports=At().default});var St=w(($i,Pt)=>{function N(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}Pt.exports=N;N.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};N.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};N.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var i=this;return this._timer=setTimeout(function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout(function(){i._operationTimeoutCb(i._attempts)},i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)},t),this._options.unref&&this._timer.unref(),!0};N.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};N.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};N.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};N.prototype.start=N.prototype.try;N.prototype.errors=function(){return this._errors};N.prototype.attempts=function(){return this._attempts};N.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,i=0;i<this._errors.length;i++){var n=this._errors[i],s=n.message,a=(r[s]||0)+1;r[s]=a,a>=t&&(e=n,t=a)}return e}});var _t=w(se=>{var zr=St();se.operation=function(r){var e=se.timeouts(r);return new zr(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};se.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],n=0;n<e.retries;n++)i.push(this.createTimeout(n,e));return r&&r.forever&&!i.length&&i.push(this.createTimeout(n,e)),i.sort(function(s,a){return s-a}),i};se.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,i=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return i=Math.min(i,e.maxTimeout),i};se.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var i in r)typeof r[i]=="function"&&t.push(i)}for(var n=0;n<t.length;n++){var s=t[n],a=r[s];r[s]=function(c){var o=se.operation(e),l=Array.prototype.slice.call(arguments,1),g=l.pop();l.push(function(R){o.retry(R)||(R&&(arguments[0]=o.mainError()),g.apply(this,arguments))}),o.attempt(function(){c.apply(r,l)})}.bind(r,a),r[s].options=e}}});var Ot=w((Ji,Ct)=>{Ct.exports=_t()});var Vt=w((Wi,Ft)=>{var It=ve("url").parse,Yr=ve("events"),Hr=ve("https"),$r=ve("http"),Qr=ve("util"),Ze=Ot(),Jr=["pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","secureProtocol","servername","checkServerIdentity"],wt=[239,187,191],Wr=58,Xr=32,Nt=10,Zr=13,Dt=1024*256,ei=/^(cookie|authorization)$/i;function ti(r){return wt.every(function(e,t){return r[t]===e})}function p(r,e){var t=p.CONNECTING,i=e&&e.headers,n=!1;Object.defineProperty(this,"readyState",{get:function(){return t}}),Object.defineProperty(this,"url",{get:function(){return r}});var s=this;s.reconnectInterval=1e3;function a(){if(t!==p.RETRYING)return;S&&(r=S,S=null,n=!1);var m=Ze.operation({retries:3,factor:0,minTimeout:1e3,maxTimeout:1e3,randomize:!1}),v=Ze.operation({retries:15,factor:3,minTimeout:1e4,maxTimeout:15e3,randomize:!0}),A=Ze.operation({forever:!0,factor:3,minTimeout:3e5,maxTimeout:3e5,randomize:!0});function y(){m.attempt(function(b){t!==p.CLOSED&&(h("retrying",new Z("retrying",{shortTermRetryAttempt:b})),t===p.RETRYING&&(K(),!m.retry(t===p.RETRYING)&&t===p.RETRYING&&k()))})}function k(){v.attempt(function(b){t===p.RETRYING&&(h("retrying",new Z("retrying",{mediumTermRetryAttempt:b})),K(),!v.retry(t===p.RETRYING)&&t===p.RETRYING&&J())})}function J(){A.attempt(function(b){t===p.RETRYING&&(h("retrying",new Z("retrying",{longTermRetryAttempt:b})),K(),A.retry(t===p.RETRYING))})}y()}function u(m){if(m&&m.status){var v=m.status;return v===500||v===502||v===503||v===504}return!0}function c(m){if(t!==p.CLOSED&&t!==p.RETRYING){var v=new Z("error",{error:m});u(m)?(t=p.RETRYING,a()):(h("error",v),t=p.CLOSED,h("closed",new Z("closed")))}}var o,l="";i&&i["Last-Event-ID"]&&(l=i["Last-Event-ID"],delete i["Last-Event-ID"]);var g=!1,R="",O="",S=null;function K(){var m=It(r),v=m.protocol==="https:";if(m.headers={"Cache-Control":"no-cache",Accept:"text/event-stream"},l&&(m.headers["Last-Event-ID"]=l),i){var A=n?ii(i):i;for(var y in A){var k=A[y];k&&(m.headers[y]=k)}}m.rejectUnauthorized=!(e&&!e.rejectUnauthorized),e&&e.createConnection!==void 0&&(m.createConnection=e.createConnection);var J=e&&e.proxy;if(J){var b=It(e.proxy);v=b.protocol==="https:",m.protocol=v?"https:":"http:",m.path=r,m.headers.Host=m.host,m.hostname=b.hostname,m.host=b.host,m.port=b.port}if(e&&e.https){for(var L in e.https)if(Jr.indexOf(L)!==-1){var le=e.https[L];le!==void 0&&(m[L]=le)}}e&&e.withCredentials!==void 0&&(m.withCredentials=e.withCredentials),o=(v?Hr:$r).request(m,function(E){if(E.statusCode>=400&&E.statusCode<=599){c({status:E.statusCode,message:E.statusMessage});return}if(E.statusCode===301||E.statusCode===302||E.statusCode===307){var Be=E.headers.location;if(!Be){c({status:E.statusCode,message:E.statusMessage});return}var yr=new URL(r).origin,Er=new URL(Be).origin;n=yr!==Er,E.statusCode===307&&(S=r),r=Be,process.nextTick(K);return}if(E.statusCode>=400&&E.statusCode<=599)return h("error",new Z("error",{status:E.statusCode,message:E.statusMessage})),s.close();t=p.OPEN,E.on("close",function(){E.removeAllListeners("close"),E.removeAllListeners("end"),c()}),E.on("end",function(){E.removeAllListeners("close"),E.removeAllListeners("end"),c()}),h("open",new Z("open"));var x,qe,Me=0,Ge=-1,be=0,j=0;E.on("data",function(ce){x?(ce.length>x.length-j&&(be=x.length*2+ce.length,be>Dt&&(be=x.length+ce.length+Dt),qe=Buffer.alloc(be),x.copy(qe,0,0,j),x=qe),ce.copy(x,j),j+=ce.length):(x=ce,ti(x)&&(x=x.slice(wt.length)),j=x.length);for(var I=0,xe=j;I<xe;){g&&(x[I]===Nt&&++I,g=!1);for(var fe=-1,Pe=Ge,Se,he=Me;fe<0&&he<xe;++he)Se=x[he],Se===Wr?Pe<0&&(Pe=he-I):Se===Zr?(g=!0,fe=he-I):Se===Nt&&(fe=he-I);if(fe<0){Me=xe-I,Ge=Pe;break}else Me=0,Ge=-1;T(x,I,Pe,fe),I+=fe+1}I===xe?(x=void 0,j=0):I>0&&(x=x.slice(I,j),j=x.length)})}),o.on("error",function(E){c(E.message)});var W=3e4;o.setTimeout(W),o.on("timeout",function(){c({message:`Read timeout, received no data in ${W}ms, assuming connection is dead`})}),o.setNoDelay&&o.setNoDelay(!0),o.end()}K();function h(){s.listeners(arguments[0]).length>0&&s.emit.apply(s,arguments)}this._close=function(){t!==p.CLOSED&&(t=p.CLOSED,o.abort&&o.abort(),o.xhr&&o.xhr.abort&&o.xhr.abort(),h("closed",new Z("closed")))};function T(m,v,A,y){if(y===0){if(R.length>0){var k=O||"message";h(k,new ri(k,{data:R.slice(0,-1),lastEventId:l,origin:new URL(r).origin})),R=""}O=void 0}else if(A>0){var J=A<0,b=0,L=m.slice(v,v+(J?y:A)).toString();J?b=y:m[v+A+1]!==Xr?b=A+1:b=A+2,v+=b;var le=y-b,W=m.slice(v,v+le).toString();L==="data"?R+=W+`
`:L==="event"?O=W:L==="id"&&(l=W)}}}Ft.exports=p;Qr.inherits(p,Yr.EventEmitter);p.prototype.constructor=p;["open","error","retrying","closed","message"].forEach(function(r){Object.defineProperty(p.prototype,"on"+r,{get:function(){var t=this.listeners(r)[0];return t?t._listener?t._listener:t:void 0},set:function(t){this.removeAllListeners(r),this.addEventListener(r,t)}})});Object.defineProperty(p,"CONNECTING",{enumerable:!0,value:0});Object.defineProperty(p,"OPEN",{enumerable:!0,value:1});Object.defineProperty(p,"CLOSED",{enumerable:!0,value:2});Object.defineProperty(p,"RETRYING",{enumerable:!0,value:3});p.prototype.CONNECTING=0;p.prototype.OPEN=1;p.prototype.CLOSED=2;p.prototype.RETRYING=3;p.prototype.close=function(){this._close()};p.prototype.addEventListener=function(e,t){typeof t=="function"&&(t._listener=t,this.on(e,t))};p.prototype.dispatchEvent=function(e){if(!e.type)throw new Error("UNSPECIFIED_EVENT_TYPE_ERR");this.emit(e.type,e)};p.prototype.removeEventListener=function(e,t){typeof t=="function"&&(t._listener=void 0,this.removeListener(e,t))};function Z(r,e){if(Object.defineProperty(this,"type",{writable:!1,value:r,enumerable:!0}),e)for(var t in e)e.hasOwnProperty(t)&&Object.defineProperty(this,t,{writable:!1,value:e[t],enumerable:!0})}function ri(r,e){Object.defineProperty(this,"type",{writable:!1,value:r,enumerable:!0});for(var t in e)e.hasOwnProperty(t)&&Object.defineProperty(this,t,{writable:!1,value:e[t],enumerable:!0})}function ii(r){var e={};for(var t in r)ei.test(t)||(e[t]=r[t]);return e}});var Bt=w((rn,Lt)=>{"use strict";Lt.exports=function(r){r.prototype[Symbol.iterator]=function*(){for(let e=this.head;e;e=e.next)yield e.value}}});var Mt=w((nn,qt)=>{"use strict";qt.exports=d;d.Node=ae;d.create=d;function d(r){var e=this;if(e instanceof d||(e=new d),e.tail=null,e.head=null,e.length=0,r&&typeof r.forEach=="function")r.forEach(function(n){e.push(n)});else if(arguments.length>0)for(var t=0,i=arguments.length;t<i;t++)e.push(arguments[t]);return e}d.prototype.removeNode=function(r){if(r.list!==this)throw new Error("removing node which does not belong to this list");var e=r.next,t=r.prev;return e&&(e.prev=t),t&&(t.next=e),r===this.head&&(this.head=e),r===this.tail&&(this.tail=t),r.list.length--,r.next=null,r.prev=null,r.list=null,e};d.prototype.unshiftNode=function(r){if(r!==this.head){r.list&&r.list.removeNode(r);var e=this.head;r.list=this,r.next=e,e&&(e.prev=r),this.head=r,this.tail||(this.tail=r),this.length++}};d.prototype.pushNode=function(r){if(r!==this.tail){r.list&&r.list.removeNode(r);var e=this.tail;r.list=this,r.prev=e,e&&(e.next=r),this.tail=r,this.head||(this.head=r),this.length++}};d.prototype.push=function(){for(var r=0,e=arguments.length;r<e;r++)si(this,arguments[r]);return this.length};d.prototype.unshift=function(){for(var r=0,e=arguments.length;r<e;r++)ai(this,arguments[r]);return this.length};d.prototype.pop=function(){if(!!this.tail){var r=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,r}};d.prototype.shift=function(){if(!!this.head){var r=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,r}};d.prototype.forEach=function(r,e){e=e||this;for(var t=this.head,i=0;t!==null;i++)r.call(e,t.value,i,this),t=t.next};d.prototype.forEachReverse=function(r,e){e=e||this;for(var t=this.tail,i=this.length-1;t!==null;i--)r.call(e,t.value,i,this),t=t.prev};d.prototype.get=function(r){for(var e=0,t=this.head;t!==null&&e<r;e++)t=t.next;if(e===r&&t!==null)return t.value};d.prototype.getReverse=function(r){for(var e=0,t=this.tail;t!==null&&e<r;e++)t=t.prev;if(e===r&&t!==null)return t.value};d.prototype.map=function(r,e){e=e||this;for(var t=new d,i=this.head;i!==null;)t.push(r.call(e,i.value,this)),i=i.next;return t};d.prototype.mapReverse=function(r,e){e=e||this;for(var t=new d,i=this.tail;i!==null;)t.push(r.call(e,i.value,this)),i=i.prev;return t};d.prototype.reduce=function(r,e){var t,i=this.head;if(arguments.length>1)t=e;else if(this.head)i=this.head.next,t=this.head.value;else throw new TypeError("Reduce of empty list with no initial value");for(var n=0;i!==null;n++)t=r(t,i.value,n),i=i.next;return t};d.prototype.reduceReverse=function(r,e){var t,i=this.tail;if(arguments.length>1)t=e;else if(this.tail)i=this.tail.prev,t=this.tail.value;else throw new TypeError("Reduce of empty list with no initial value");for(var n=this.length-1;i!==null;n--)t=r(t,i.value,n),i=i.prev;return t};d.prototype.toArray=function(){for(var r=new Array(this.length),e=0,t=this.head;t!==null;e++)r[e]=t.value,t=t.next;return r};d.prototype.toArrayReverse=function(){for(var r=new Array(this.length),e=0,t=this.tail;t!==null;e++)r[e]=t.value,t=t.prev;return r};d.prototype.slice=function(r,e){e=e||this.length,e<0&&(e+=this.length),r=r||0,r<0&&(r+=this.length);var t=new d;if(e<r||e<0)return t;r<0&&(r=0),e>this.length&&(e=this.length);for(var i=0,n=this.head;n!==null&&i<r;i++)n=n.next;for(;n!==null&&i<e;i++,n=n.next)t.push(n.value);return t};d.prototype.sliceReverse=function(r,e){e=e||this.length,e<0&&(e+=this.length),r=r||0,r<0&&(r+=this.length);var t=new d;if(e<r||e<0)return t;r<0&&(r=0),e>this.length&&(e=this.length);for(var i=this.length,n=this.tail;n!==null&&i>e;i--)n=n.prev;for(;n!==null&&i>r;i--,n=n.prev)t.push(n.value);return t};d.prototype.splice=function(r,e,...t){r>this.length&&(r=this.length-1),r<0&&(r=this.length+r);for(var i=0,n=this.head;n!==null&&i<r;i++)n=n.next;for(var s=[],i=0;n&&i<e;i++)s.push(n.value),n=this.removeNode(n);n===null&&(n=this.tail),n!==this.head&&n!==this.tail&&(n=n.prev);for(var i=0;i<t.length;i++)n=ni(this,n,t[i]);return s};d.prototype.reverse=function(){for(var r=this.head,e=this.tail,t=r;t!==null;t=t.prev){var i=t.prev;t.prev=t.next,t.next=i}return this.head=e,this.tail=r,this};function ni(r,e,t){var i=e===r.head?new ae(t,null,e,r):new ae(t,e,e.next,r);return i.next===null&&(r.tail=i),i.prev===null&&(r.head=i),r.length++,i}function si(r,e){r.tail=new ae(e,r.tail,null,r),r.head||(r.head=r.tail),r.length++}function ai(r,e){r.head=new ae(e,null,r.head,r),r.tail||(r.tail=r.head),r.length++}function ae(r,e,t,i){if(!(this instanceof ae))return new ae(r,e,t,i);this.list=i,this.value=r,e?(e.next=this,this.prev=e):this.prev=null,t?(t.prev=this,this.next=t):this.next=null}try{Bt()(d)}catch(r){}});var it=w((sn,Yt)=>{"use strict";var oi=Mt(),oe=Symbol("max"),$=Symbol("length"),me=Symbol("lengthCalculator"),Te=Symbol("allowStale"),ue=Symbol("maxAge"),Q=Symbol("dispose"),Gt=Symbol("noDisposeOnSet"),P=Symbol("lruList"),U=Symbol("cache"),Kt=Symbol("updateAgeOnGet"),tt=()=>1,kt=class{constructor(e){if(typeof e=="number"&&(e={max:e}),e||(e={}),e.max&&(typeof e.max!="number"||e.max<0))throw new TypeError("max must be a non-negative number");let t=this[oe]=e.max||1/0,i=e.length||tt;if(this[me]=typeof i!="function"?tt:i,this[Te]=e.stale||!1,e.maxAge&&typeof e.maxAge!="number")throw new TypeError("maxAge must be a number");this[ue]=e.maxAge||0,this[Q]=e.dispose,this[Gt]=e.noDisposeOnSet||!1,this[Kt]=e.updateAgeOnGet||!1,this.reset()}set max(e){if(typeof e!="number"||e<0)throw new TypeError("max must be a non-negative number");this[oe]=e||1/0,Re(this)}get max(){return this[oe]}set allowStale(e){this[Te]=!!e}get allowStale(){return this[Te]}set maxAge(e){if(typeof e!="number")throw new TypeError("maxAge must be a non-negative number");this[ue]=e,Re(this)}get maxAge(){return this[ue]}set lengthCalculator(e){typeof e!="function"&&(e=tt),e!==this[me]&&(this[me]=e,this[$]=0,this[P].forEach(t=>{t.length=this[me](t.value,t.key),this[$]+=t.length})),Re(this)}get lengthCalculator(){return this[me]}get length(){return this[$]}get itemCount(){return this[P].length}rforEach(e,t){t=t||this;for(let i=this[P].tail;i!==null;){let n=i.prev;zt(this,e,i,t),i=n}}forEach(e,t){t=t||this;for(let i=this[P].head;i!==null;){let n=i.next;zt(this,e,i,t),i=n}}keys(){return this[P].toArray().map(e=>e.key)}values(){return this[P].toArray().map(e=>e.value)}reset(){this[Q]&&this[P]&&this[P].length&&this[P].forEach(e=>this[Q](e.key,e.value)),this[U]=new Map,this[P]=new oi,this[$]=0}dump(){return this[P].map(e=>Ve(this,e)?!1:{k:e.key,v:e.value,e:e.now+(e.maxAge||0)}).toArray().filter(e=>e)}dumpLru(){return this[P]}set(e,t,i){if(i=i||this[ue],i&&typeof i!="number")throw new TypeError("maxAge must be a number");let n=i?Date.now():0,s=this[me](t,e);if(this[U].has(e)){if(s>this[oe])return pe(this,this[U].get(e)),!1;let c=this[U].get(e).value;return this[Q]&&(this[Gt]||this[Q](e,c.value)),c.now=n,c.maxAge=i,c.value=t,this[$]+=s-c.length,c.length=s,this.get(e),Re(this),!0}let a=new jt(e,t,s,n,i);return a.length>this[oe]?(this[Q]&&this[Q](e,t),!1):(this[$]+=a.length,this[P].unshift(a),this[U].set(e,this[P].head),Re(this),!0)}has(e){if(!this[U].has(e))return!1;let t=this[U].get(e).value;return!Ve(this,t)}get(e){return rt(this,e,!0)}peek(e){return rt(this,e,!1)}pop(){let e=this[P].tail;return e?(pe(this,e),e.value):null}del(e){pe(this,this[U].get(e))}load(e){this.reset();let t=Date.now();for(let i=e.length-1;i>=0;i--){let n=e[i],s=n.e||0;if(s===0)this.set(n.k,n.v);else{let a=s-t;a>0&&this.set(n.k,n.v,a)}}}prune(){this[U].forEach((e,t)=>rt(this,t,!1))}},rt=(r,e,t)=>{let i=r[U].get(e);if(i){let n=i.value;if(Ve(r,n)){if(pe(r,i),!r[Te])return}else t&&(r[Kt]&&(i.value.now=Date.now()),r[P].unshiftNode(i));return n.value}},Ve=(r,e)=>{if(!e||!e.maxAge&&!r[ue])return!1;let t=Date.now()-e.now;return e.maxAge?t>e.maxAge:r[ue]&&t>r[ue]},Re=r=>{if(r[$]>r[oe])for(let e=r[P].tail;r[$]>r[oe]&&e!==null;){let t=e.prev;pe(r,e),e=t}},pe=(r,e)=>{if(e){let t=e.value;r[Q]&&r[Q](t.key,t.value),r[$]-=t.length,r[U].delete(t.key),r[P].removeNode(e)}},jt=class{constructor(e,t,i,n,s){this.key=e,this.value=t,this.length=i,this.now=n,this.maxAge=s||0}},zt=(r,e,t,i)=>{let n=t.value;Ve(r,n)&&(pe(r,t),r[Te]||(n=void 0)),n&&e.call(i,n.value,n.key,r)};Yt.exports=kt});var gr=w((gn,st)=>{(function(){var r=this;let e=a=>new TextEncoder().encode(a);function t(a,u){typeof a=="string"&&(a=e(a));for(var c=a.length,o=u^c,l=0,g;c>=4;)g=a[l]&255|(a[++l]&255)<<8|(a[++l]&255)<<16|(a[++l]&255)<<24,g=(g&65535)*1540483477+(((g>>>16)*1540483477&65535)<<16),g^=g>>>24,g=(g&65535)*1540483477+(((g>>>16)*1540483477&65535)<<16),o=(o&65535)*1540483477+(((o>>>16)*1540483477&65535)<<16)^g,c-=4,++l;switch(c){case 3:o^=(a[l+2]&255)<<16;case 2:o^=(a[l+1]&255)<<8;case 1:o^=a[l]&255,o=(o&65535)*1540483477+(((o>>>16)*1540483477&65535)<<16)}return o^=o>>>13,o=(o&65535)*1540483477+(((o>>>16)*1540483477&65535)<<16),o^=o>>>15,o>>>0}function i(a,u){typeof a=="string"&&(a=e(a));var c,o,l,g,R,O,S,K,h,T;for(c=a.length&3,o=a.length-c,l=u,R=3432918353,S=461845907,T=0;T<o;)h=a[T]&255|(a[++T]&255)<<8|(a[++T]&255)<<16|(a[++T]&255)<<24,++T,h=(h&65535)*R+(((h>>>16)*R&65535)<<16)&4294967295,h=h<<15|h>>>17,h=(h&65535)*S+(((h>>>16)*S&65535)<<16)&4294967295,l^=h,l=l<<13|l>>>19,g=(l&65535)*5+(((l>>>16)*5&65535)<<16)&4294967295,l=(g&65535)+27492+(((g>>>16)+58964&65535)<<16);switch(h=0,c){case 3:h^=(a[T+2]&255)<<16;case 2:h^=(a[T+1]&255)<<8;case 1:h^=a[T]&255,h=(h&65535)*R+(((h>>>16)*R&65535)<<16)&4294967295,h=h<<15|h>>>17,h=(h&65535)*S+(((h>>>16)*S&65535)<<16)&4294967295,l^=h}return l^=a.length,l^=l>>>16,l=(l&65535)*2246822507+(((l>>>16)*2246822507&65535)<<16)&4294967295,l^=l>>>13,l=(l&65535)*3266489909+(((l>>>16)*3266489909&65535)<<16)&4294967295,l^=l>>>16,l>>>0}var n=i;if(n.v2=t,n.v3=i,typeof st!="undefined")st.exports=n;else{var s=r.murmur;n.noConflict=function(){return r.murmur=s,n},r.murmur=n}})()});var dr=ge(pt()),ut=ge(xt());import pi from"events";import vr from"axios";var _;(function(a){a.READY="stream_ready",a.CONNECTED="stream_connected",a.RETRYING="stream_retrying",a.DISCONNECTED="stream_disconnected",a.CHANGED="stream_changed",a.ERROR="stream_error"})(_||(_={}));import H from"axios";import Gr from"axios";var V="http://localhost/api/1.0".replace(/\/+$/,"");var Ie=class{constructor(e,t=V,i=Gr){this.basePath=t;this.axios=i;e&&(this.configuration=e,this.basePath=e.basePath||this.basePath)}},$e=class extends Error{constructor(e,t){super(t);this.field=e;this.name="RequiredError"}};var B="https://example.com",C=function(r,e,t){if(t==null)throw new $e(e,`Required parameter ${e} was null or undefined when calling ${r}.`)};var Y=async function(r,e){if(e&&e.accessToken){let t=typeof e.accessToken=="function"?await e.accessToken():await e.accessToken;r.Authorization="Bearer "+t}};var q=function(r,...e){let t=new URLSearchParams(r.search);for(let i of e)for(let n in i)if(Array.isArray(i[n])){t.delete(n);for(let s of i[n])t.append(n,s)}else t.set(n,i[n]);r.search=t.toString()},Qe=function(r,e,t){let i=typeof r!="string";return(i&&t&&t.isJsonMime?t.isJsonMime(e.headers["Content-Type"]):i)?JSON.stringify(r!==void 0?r:{}):r||""},M=function(r){return r.pathname+r.search+r.hash},G=function(r,e,t,i){return(n=e,s=t)=>{let a=Ce(f({},r.options),{url:((i==null?void 0:i.basePath)||s)+r.url});return n.request(a)}};var ie;(function(n){n.Boolean="boolean",n.Int="int",n.String="string",n.Json="json"})(ie||(ie={}));var we;(function(t){t.On="on",t.Off="off"})(we||(we={}));var Ne;(function(e){e.Ffmetrics="FFMETRICS"})(Ne||(Ne={}));var Kr=function(r){return{authenticate:async(e,t={})=>{let i="/client/auth",n=new URL(i,B),s;r&&(s=r.baseOptions);let a=f(f({method:"POST"},s),t),u={},c={};u["Content-Type"]="application/json",q(n,c,t.query);let o=s&&s.headers?s.headers:{};return a.headers=f(f(f({},u),o),t.headers),a.data=Qe(e,a,r),{url:M(n),options:a}},getAllSegments:async(e,t,i={})=>{C("getAllSegments","environmentUUID",e);let n="/client/env/{environmentUUID}/target-segments".replace("{environmentUUID}",encodeURIComponent(String(e))),s=new URL(n,B),a;r&&(a=r.baseOptions);let u=f(f({method:"GET"},a),i),c={},o={};await Y(c,r),t!==void 0&&(o.cluster=t),q(s,o,i.query);let l=a&&a.headers?a.headers:{};return u.headers=f(f(f({},c),l),i.headers),{url:M(s),options:u}},getEvaluationByIdentifier:async(e,t,i,n,s={})=>{C("getEvaluationByIdentifier","environmentUUID",e),C("getEvaluationByIdentifier","feature",t),C("getEvaluationByIdentifier","target",i);let a="/client/env/{environmentUUID}/target/{target}/evaluations/{feature}".replace("{environmentUUID}",encodeURIComponent(String(e))).replace("{feature}",encodeURIComponent(String(t))).replace("{target}",encodeURIComponent(String(i))),u=new URL(a,B),c;r&&(c=r.baseOptions);let o=f(f({method:"GET"},c),s),l={},g={};await Y(l,r),n!==void 0&&(g.cluster=n),q(u,g,s.query);let R=c&&c.headers?c.headers:{};return o.headers=f(f(f({},l),R),s.headers),{url:M(u),options:o}},getEvaluations:async(e,t,i,n={})=>{C("getEvaluations","environmentUUID",e),C("getEvaluations","target",t);let s="/client/env/{environmentUUID}/target/{target}/evaluations".replace("{environmentUUID}",encodeURIComponent(String(e))).replace("{target}",encodeURIComponent(String(t))),a=new URL(s,B),u;r&&(u=r.baseOptions);let c=f(f({method:"GET"},u),n),o={},l={};await Y(o,r),i!==void 0&&(l.cluster=i),q(a,l,n.query);let g=u&&u.headers?u.headers:{};return c.headers=f(f(f({},o),g),n.headers),{url:M(a),options:c}},getFeatureConfig:async(e,t,i={})=>{C("getFeatureConfig","environmentUUID",e);let n="/client/env/{environmentUUID}/feature-configs".replace("{environmentUUID}",encodeURIComponent(String(e))),s=new URL(n,B),a;r&&(a=r.baseOptions);let u=f(f({method:"GET"},a),i),c={},o={};await Y(c,r),t!==void 0&&(o.cluster=t),q(s,o,i.query);let l=a&&a.headers?a.headers:{};return u.headers=f(f(f({},c),l),i.headers),{url:M(s),options:u}},getFeatureConfigByIdentifier:async(e,t,i,n={})=>{C("getFeatureConfigByIdentifier","identifier",e),C("getFeatureConfigByIdentifier","environmentUUID",t);let s="/client/env/{environmentUUID}/feature-configs/{identifier}".replace("{identifier}",encodeURIComponent(String(e))).replace("{environmentUUID}",encodeURIComponent(String(t))),a=new URL(s,B),u;r&&(u=r.baseOptions);let c=f(f({method:"GET"},u),n),o={},l={};await Y(o,r),i!==void 0&&(l.cluster=i),q(a,l,n.query);let g=u&&u.headers?u.headers:{};return c.headers=f(f(f({},o),g),n.headers),{url:M(a),options:c}},getSegmentByIdentifier:async(e,t,i,n={})=>{C("getSegmentByIdentifier","identifier",e),C("getSegmentByIdentifier","environmentUUID",t);let s="/client/env/{environmentUUID}/target-segments/{identifier}".replace("{identifier}",encodeURIComponent(String(e))).replace("{environmentUUID}",encodeURIComponent(String(t))),a=new URL(s,B),u;r&&(u=r.baseOptions);let c=f(f({method:"GET"},u),n),o={},l={};await Y(o,r),i!==void 0&&(l.cluster=i),q(a,l,n.query);let g=u&&u.headers?u.headers:{};return c.headers=f(f(f({},o),g),n.headers),{url:M(a),options:c}},stream:async(e,t,i={})=>{C("stream","aPIKey",e);let n="/stream",s=new URL(n,B),a;r&&(a=r.baseOptions);let u=f(f({method:"GET"},a),i),c={},o={};await Y(c,r),t!==void 0&&(o.cluster=t),e!=null&&(c["API-Key"]=String(e)),q(s,o,i.query);let l=a&&a.headers?a.headers:{};return u.headers=f(f(f({},c),l),i.headers),{url:M(s),options:u}}}},X=function(r){let e=Kr(r);return{async authenticate(t,i){let n=await e.authenticate(t,i);return G(n,H,V,r)},async getAllSegments(t,i,n){let s=await e.getAllSegments(t,i,n);return G(s,H,V,r)},async getEvaluationByIdentifier(t,i,n,s,a){let u=await e.getEvaluationByIdentifier(t,i,n,s,a);return G(u,H,V,r)},async getEvaluations(t,i,n,s){let a=await e.getEvaluations(t,i,n,s);return G(a,H,V,r)},async getFeatureConfig(t,i,n){let s=await e.getFeatureConfig(t,i,n);return G(s,H,V,r)},async getFeatureConfigByIdentifier(t,i,n,s){let a=await e.getFeatureConfigByIdentifier(t,i,n,s);return G(a,H,V,r)},async getSegmentByIdentifier(t,i,n,s){let a=await e.getSegmentByIdentifier(t,i,n,s);return G(a,H,V,r)},async stream(t,i,n){let s=await e.stream(t,i,n);return G(s,H,V,r)}}};var Je=class extends Ie{authenticate(e,t){return X(this.configuration).authenticate(e,t).then(i=>i(this.axios,this.basePath))}getAllSegments(e,t,i){return X(this.configuration).getAllSegments(e,t,i).then(n=>n(this.axios,this.basePath))}getEvaluationByIdentifier(e,t,i,n,s){return X(this.configuration).getEvaluationByIdentifier(e,t,i,n,s).then(a=>a(this.axios,this.basePath))}getEvaluations(e,t,i,n){return X(this.configuration).getEvaluations(e,t,i,n).then(s=>s(this.axios,this.basePath))}getFeatureConfig(e,t,i){return X(this.configuration).getFeatureConfig(e,t,i).then(n=>n(this.axios,this.basePath))}getFeatureConfigByIdentifier(e,t,i,n){return X(this.configuration).getFeatureConfigByIdentifier(e,t,i,n).then(s=>s(this.axios,this.basePath))}getSegmentByIdentifier(e,t,i,n){return X(this.configuration).getSegmentByIdentifier(e,t,i,n).then(s=>s(this.axios,this.basePath))}stream(e,t,i){return X(this.configuration).stream(e,t,i).then(n=>n(this.axios,this.basePath))}},kr=function(r){return{postMetrics:async(e,t,i,n={})=>{C("postMetrics","environment",e);let s="/metrics/{environment}".replace("{environment}",encodeURIComponent(String(e))),a=new URL(s,B),u;r&&(u=r.baseOptions);let c=f(f({method:"POST"},u),n),o={},l={};await Y(o,r),t!==void 0&&(l.cluster=t),o["Content-Type"]="application/json",q(a,l,n.query);let g=u&&u.headers?u.headers:{};return c.headers=f(f(f({},o),g),n.headers),c.data=Qe(i,c,r),{url:M(a),options:c}}}},jr=function(r){let e=kr(r);return{async postMetrics(t,i,n,s){let a=await e.postMetrics(t,i,n,s);return G(a,H,V,r)}}};var We=class extends Ie{postMetrics(e,t,i,n){return jr(this.configuration).postMetrics(e,t,i,n).then(s=>s(this.axios,this.basePath))}};var Ee=class{constructor(e={}){this.apiKey=e.apiKey,this.username=e.username,this.password=e.password,this.accessToken=e.accessToken,this.basePath=e.basePath,this.baseOptions=e.baseOptions,this.formDataCtor=e.formDataCtor}isJsonMime(e){let t=new RegExp("^(application/json|[^;/ 	]+/[^;/ 	]+[+]json)[ 	]*(;.*)?$","i");return e!==null&&(t.test(e)||e.toLowerCase()==="application/json-patch+json")}};var De="1.2.11";var ne;(function(t){t.READY="poller_ready",t.ERROR="poller_error"})(ne||(ne={}));var Xe=class{constructor(e,t,i,n,s,a){this.stopped=!0;this.initialized=!1;this.api=i,this.options=n,this.environment=e,this.cluster=t,this.repository=a,this.eventBus=s,this.log=n.logger}poll(){if(this.stopped){this.log.info("PollingProcessor stopped");return}let e=new Date().getTime(),t=()=>{let i=new Date().getTime()-e,n=Math.max(this.options.pollInterval-i,0);this.timeout=setTimeout(()=>this.poll(),n)};Promise.all([this.retrieveFlags(),this.retrieveSegments()]).then(()=>{this.initialized||(this.initialized=!0,this.eventBus.emit(ne.READY))}).catch(i=>{this.eventBus.emit(ne.ERROR,{error:i})}).finally(()=>{if(this.stopped){this.log.info("PollingProcessor stopped");return}t()})}async retrieveFlags(){try{this.log.debug("Fetching flags started");let e=await this.api.getFeatureConfig(this.environment,this.cluster);this.log.debug("Fetching flags finished"),e.data.forEach(t=>this.repository.setFlag(t.feature,t))}catch(e){throw this.log.error("Error loading flags",e),e}}async retrieveSegments(){try{this.log.debug("Fetching segments started");let e=await this.api.getAllSegments(this.environment,this.cluster);this.log.debug("Fetching segments finished"),e.data.forEach(t=>this.repository.setSegment(t.identifier,t))}catch(e){throw this.log.error("Error loading segments",e),e}}start(){if(!this.stopped){this.log.info("PollingProcessor already started");return}this.log.info("Starting PollingProcessor with request interval: ",this.options.pollInterval),this.stopped=!1,this.poll()}stop(){this.log.info("Stopping PollingProcessor"),this.stopped=!0}close(){this.log.info("Closing PollingProcessor"),this.stop(),clearTimeout(this.timeout),this.log.info("PollingProcessor closed")}};var Ut=ge(Vt());var et=class{constructor(e,t,i,n,s,a,u,c){this.api=e,this.apiKey=t,this.environment=i,this.jwtToken=n,this.options=s,this.cluster=a,this.eventBus=u,this.repository=c,this.log=this.options.logger}start(){this.log.info("Starting StreamProcessor");let e=new Ut.default(`${this.options.baseUrl}/stream?cluster=${this.cluster}`,{headers:{Authorization:`Bearer ${this.jwtToken}`,"API-Key":this.apiKey}});e.onopen=t=>{this.log.debug("Stream connected",t),this.eventBus.emit(_.CONNECTED),this.isRetrying=!1},e.onretrying=t=>{this.log.error("Stream is trying to reconnect",t),this.isRetrying||(this.isRetrying=!0,this.eventBus.emit(_.RETRYING))},e.onerror=t=>{this.log.error("Unrecoverable error with stream, not retrying to connect: ",t),this.eventBus.emit(_.ERROR,t)},e.addEventListener("*",t=>{let i=JSON.parse(t.data);this.log.debug("Received event from stream: ",i),i.domain==="flag"?this.msgProcessor(i,this.api.getFeatureConfigByIdentifier.bind(this.api),this.repository.setFlag.bind(this.repository),this.repository.deleteFlag.bind(this.repository)):i.domain==="target-segment"&&this.msgProcessor(i,this.api.getSegmentByIdentifier.bind(this.api),this.repository.setSegment.bind(this.repository),this.repository.deleteSegment.bind(this.repository))}),this.eventSource=e,this.eventBus.emit(_.READY)}async msgProcessor(e,t,i,n){this.log.info("Processing message",e);try{if(e.event==="create"||e.event==="patch"){let{data:s}=await t(e.identifier,this.environment,this.cluster);i(e.identifier,s)}else e.event==="delete"&&n(e.identifier)}catch(s){throw this.log.error("Error while fetching data with identifier:",e.identifier,s),s}this.log.info("Processing message finished",e)}connected(){return this.eventSource.readyState==et.CONNECTED}stop(){this.log.info("Stopping StreamProcessor"),this.eventSource.close(),this.eventBus.emit(_.DISCONNECTED)}close(){this.log.info("Closing StreamProcessor"),this.stop(),this.log.info("StreamProcessor closed")}},Fe=et;Fe.CONNECTED=1;var Ht=ge(it());var nt=class{trace(e,...t){console.trace(e,...t)}debug(e,...t){console.debug(e,...t)}info(e,...t){console.info(e,...t)}warn(e,...t){console.warn(e,...t)}error(e,...t){console.error(e,...t)}};import ui from"keyv";import{KeyvFile as li}from"keyv-file";var Ue=class{constructor(e={}){this.keyvFile=new li(e),this.keyv=new ui({store:this.keyvFile})}set(e,t){return this.keyv.set(e,t)}get(e){return this.keyv.get(e)}del(e){return this.keyv.delete(e)}keys(){return Promise.resolve(this.keyvFile.keys())}};var $t=100;var Qt="featureIdentifier",Jt="featureName",Wt="variationIdentifier";var Xt="target",Zt="SDK_VERSION",er="SDK_TYPE",tr="server",rr="SDK_LANGUAGE",ir="javascript",nr="global",Ae="segmentMatch",sr="in",ar="equal",or="gt",ur="starts_with",lr="ends_with",cr="contains",fr="equal_sensitive",ci="https://config.ff.harness.io/api/1.0",fi="https://events.ff.harness.io/api/1.0",hi=1e3,hr=60*hi,gi=1*hr,mi=1*hr,ee={baseUrl:ci,eventsUrl:fi,pollInterval:gi,eventsSyncInterval:mi,enableStream:!0,enableAnalytics:!0,cache:new Ht.default({max:100}),store:new Ue,logger:new nt};var mr=ge(gr()),at=class{constructor(e,t){this.query=e,this.log=t}getAttrValue(e,t){var i;return e[t]||((i=e.attributes)==null?void 0:i[t])}findVariation(e,t){return e.find(i=>i.identifier===t)}getNormalizedNumberWithNormalizer(e,t,i){let n=[t,e].join(":");return parseInt((0,mr.default)(n).toString())%i+1}getNormalizedNumber(e,t){return this.getNormalizedNumberWithNormalizer(e,t,$t)}isEnabled(e,t,i){let n=this.getAttrValue(e,t);if(!n)return!1;let s=this.getNormalizedNumber(n,t);return i>0&&s<=i}evaluateDistribution(e,t){if(!e)return;let i="",n=0;for(let s of e.variations)if(i=s.variation,n+=s.weight,this.isEnabled(t,e.bucketBy,n))return s.variation;return i}async isTargetIncludedOrExcludedInSegment(e,t){var i,n;for(let s of e){let a=await this.query.getSegment(s);if(a){if((i=a.excluded)==null?void 0:i.find(u=>u.identifier===t.identifier))return this.log.debug(`Target %s excluded from segment %s via exclude list
`,t.name,a.name),!1;if((n=a.included)==null?void 0:n.find(u=>u.identifier===t.identifier))return this.log.debug(`Target %s included in segment %s via include list
`,t.name,a.name),!0;if(a.rules&&await this.evaluateClauses(a.rules,t))return this.log.debug(`Target %s included in segment %s via rules
`,t.name,a.name),!0}}return!1}async evaluateClause(e,t){var a;if(!(e==null?void 0:e.op)||!((a=e==null?void 0:e.values)==null?void 0:a.length))return!1;let i=this.getAttrValue(t,e.attribute),n=i==null?void 0:i.toString();if(e.op!==Ae&&!n)return!1;let s=e.values[0];switch(e.op){case sr:for(let u of e.values)if(u==n)return!0;return!1;case ar:return n.toLowerCase()==s.toLowerCase();case fr:return n==s;case or:return n>s;case ur:return n.startsWith(s);case lr:return n.endsWith(s);case cr:return n.includes(s);case Ae:return await this.isTargetIncludedOrExcludedInSegment(e.values,t)}return!1}async evaluateClauses(e,t){for(let i of e)if(await this.evaluateClause(i,t))return!0;return!1}evaluateRule(e,t){return this.evaluateClauses(e.clauses,t)}async evaluateRules(e,t){if(!t||!e)return;e.sort((n,s)=>n.priority>s.priority?1:-1);let i;for(let n of e)if(!!await this.evaluateRule(n,t))return n.serve.distribution&&(i=this.evaluateDistribution(n.serve.distribution,t)),n.serve.variation&&(i=n.serve.variation),i}async evaluateVariationMap(e,t){var i;if(!(!t||!e))for(let n of e){if((i=n.targets)==null?void 0:i.find(u=>u.identifier===t.identifier))return n.variation;let a=n.targetSegments;if(a&&await this.isTargetIncludedOrExcludedInSegment(a,t))return n.variation}}async evaluateFlag(e,t){let i=e.offVariation;return e.state===we.On&&(i=await this.evaluateVariationMap(e.variationToTargetMap,t)||await this.evaluateRules(e.rules,t)||this.evaluateDistribution(e.defaultServe.distribution,t)||e.defaultServe.variation),this.findVariation(e.variations,i)}async checkPreRequisite(e,t){if(e.prerequisites){this.log.info("Checking pre requisites %s of parent feature %s",e.prerequisites,e.feature);for(let i of e.prerequisites){let n=await this.query.getFlag(i.feature);if(!n)return this.log.warn("Could not retrieve the pre requisite details of feature flag: %s",e.feature),!0;let s=await this.evaluateFlag(n,t);return this.log.info("Pre requisite flag %s has variation %s for target %s",n.feature,s,t),this.log.info("Pre requisite flag %s should have the variations %s",n.feature,i.variations),i.variations.includes(s.identifier)?await this.checkPreRequisite(n,t):!1}}return!0}async evaluate(e,t,i,n){let s=await this.query.getFlag(e);if(!s||s.kind!==i)return;if(s.prerequisites&&!await this.checkPreRequisite(s,t))return this.findVariation(s.variations,s.offVariation);let a=await this.evaluateFlag(s,t);if(a)return n&&n(s,t,a),a}async boolVariation(e,t,i=!1,n){let s=await this.evaluate(e,t,ie.Boolean,n);return s?s.value.toLowerCase()==="true":i}async stringVariation(e,t,i="",n){let s=await this.evaluate(e,t,ie.String,n);return s?s.value:i}async numberVariation(e,t,i=0,n){let s=await this.evaluate(e,t,ie.Int,n);return s?parseFloat(s.value):i}async jsonVariation(e,t,i={},n){let s=await this.evaluate(e,t,ie.Json,n);return s?JSON.parse(s.value):i}};var D;(function(n){n.FLAG_STORED="flag_stored",n.FLAG_DELETED="flag_deleted",n.SEGMENT_STORED="segment_stored",n.SEGMENT_DELETED="segment_deleted"})(D||(D={}));var ot=class{constructor(e,t,i){if(!e)throw new Error("Cache is required argument and cannot be undefined");this.eventBus=i,this.cache=e,this.store=t}async setFlag(e,t){if(await this.isFlagOutdated(e,t))return;let i=this.formatFlagKey(e);this.store?(await this.store.set(i,t),this.cache.del(i)):this.cache.set(i,t),this.eventBus&&this.eventBus.emit(D.FLAG_STORED,e)}async setSegment(e,t){if(await this.isSegmentOutdated(e,t))return;let i=this.formatSegmentKey(e);this.store?(await this.store.set(i,t),this.cache.del(i)):this.cache.set(i,t),this.eventBus&&this.eventBus.emit(D.SEGMENT_STORED,e)}async deleteFlag(e){let t=this.formatFlagKey(e);this.store&&await this.store.del(t),this.cache.del(t),this.eventBus&&this.eventBus.emit(D.FLAG_DELETED,e)}async deleteSegment(e){let t=this.formatSegmentKey(e);this.store&&await this.store.del(t),this.cache.del(t),this.eventBus&&this.eventBus.emit(D.SEGMENT_DELETED,e)}async getFlag(e,t=!0){let i=this.formatFlagKey(e),n=this.cache.get(i);if(n)return n;if(this.store)return n=await this.store.get(i),n&&t&&this.cache.set(i,n),n}async getSegment(e,t=!0){let i=this.formatSegmentKey(e),n=this.cache.get(i);if(n)return n;if(this.store)return n=await this.store.get(i),n&&t&&this.cache.set(i,n),n}async findFlagsBySegment(e){let t=[],i=this.cache.keys();this.store&&(i=await this.store.keys());for(let n of i){let s=await this.getFlag(n);if(!s)return[];for(let a of s==null?void 0:s.rules)for(let u of a==null?void 0:a.clauses)u.op===Ae&&u.values.includes(e)&&t.push(s.feature)}return t}async isFlagOutdated(e,t){let i=await this.getFlag(e,!1);return(i==null?void 0:i.version)&&i.version>=(t==null?void 0:t.version)}async isSegmentOutdated(e,t){let i=await this.getSegment(e,!1);return(i==null?void 0:i.version)&&i.version>=(t==null?void 0:t.version)}formatFlagKey(e){return`flags/${e}`}formatSegmentKey(e){return`segments/${e}`}};var de;(function(t){t.READY="metrics_ready",t.ERROR="metrics_error"})(de||(de={}));var pr=(r,e="1",t,i,n)=>{let s=new Map,a,u=new Ee(Ce(f({},t),{basePath:i.eventsUrl})),c=new We(u),o=i.logger,l=(h,T,m)=>{let v={target:h,featureConfig:T,variation:m,count:0},A=g(v),y=s.get(A);y?y.count++:(v.count=1,s.set(A,v))},g=h=>{let T=h.featureConfig.feature,m=h.variation.identifier,v=h.variation.value;return`${T}/${m}/${v}/${nr}`},R=()=>{var v,A;if(!s){o.debug("No metrics data!");return}let h=[],T=[],m=new Map(s);s.clear();for(let y of m.values()){if(y.target&&!y.target.anonymous){let b=[];y.target.attributes&&(b=Object.entries(y.target.attributes).map(([W,E])=>({key:W,value:E})));let L=y.target.identifier;y.target.name&&(L=y.target.name);let le={identifier:y.target.identifier,name:L,attributes:b};h.push(le)}let k=[{key:Qt,value:y.featureConfig.feature},{key:Jt,value:y.featureConfig.feature},{key:Wt,value:y.variation.identifier},{key:er,value:tr},{key:rr,value:ir},{key:Zt,value:De},{key:Xt,value:(A=(v=y==null?void 0:y.target)==null?void 0:v.identifier)!=null?A:null}],J={timestamp:Date.now(),count:y.count,metricsType:Ne.Ffmetrics,attributes:k};T.push(J)}return{targetData:h,metricsData:T}},O=()=>{let h=R();h&&(o.debug("Start sending metrics data"),c.postMetrics(r,e,h).then(T=>{o.debug("Metrics server returns: ",T.status),T.status>=400&&o.error("Error while sending metrics data with status code: ",T.status)}).catch(T=>{o.debug("Metrics server returns error: ",T)}))};return{start:()=>{o.info("Starting MetricsProcessor with request interval: ",i.eventsSyncInterval),a=setInterval(O,i.eventsSyncInterval),n.emit(de.READY)},close:()=>{o.info("Closing MetricsProcessor"),clearInterval(a),O(),o.info("MetricsProcessor closed")},enqueue:l}};vr.defaults.timeout=3e4;(0,ut.default)(vr,{retries:3,retryDelay:ut.default.exponentialDelay});var te;(function(i){i[i.POLL=0]="POLL",i[i.STREAM=1]="STREAM",i[i.METRICS=2]="METRICS"})(te||(te={}));var F;(function(i){i.READY="ready",i.FAILED="failed",i.CHANGED="changed"})(F||(F={}));var Le=class{constructor(e,t={}){this.cluster="1";this.eventBus=new pi;this.initialized=!1;this.failure=!1;this.pollerReady=!1;this.streamReady=!1;this.metricReady=!1;this.closing=!1;this.sdkKey=e,this.options=f(f({},ee),t),this.log=this.options.logger,t.pollInterval<ee.pollInterval&&(this.options.pollInterval=ee.pollInterval,this.log.warn(`Polling interval cannot be lower than ${ee.pollInterval} ms`)),t.eventsSyncInterval<ee.eventsSyncInterval&&(this.options.eventsSyncInterval=ee.eventsSyncInterval,this.log.warn(`Events sync interval cannot be lower than ${ee.eventsSyncInterval} ms`)),this.configuration=new Ee({basePath:this.options.baseUrl,baseOptions:{headers:{"User-Agent":`NodeJsSDK/${De}`}}}),this.repository=new ot(this.options.cache,this.options.store,this.eventBus),this.evaluator=new at(this.repository,this.log),this.api=new Je(this.configuration),this.processEvents(),this.run()}processEvents(){this.eventBus.on(ne.READY,()=>{this.initialize(0)}),this.eventBus.on(ne.ERROR,()=>{this.failure=!0,this.eventBus.emit(F.FAILED)}),this.eventBus.on(_.READY,()=>{this.initialize(1)}),this.eventBus.on(_.RETRYING,()=>{this.failure=!0,this.log.error("Issue with streaming: falling back to polling while the SDK attempts to reconnect"),this.closing||this.pollProcessor.start()}),this.eventBus.on(_.ERROR,()=>{this.failure=!0,this.log.error("Unrecoverable issue with streaming: falling back to polling"),this.closing||this.pollProcessor.start(),this.eventBus.emit(F.FAILED)}),this.eventBus.on(de.READY,()=>{this.initialize(2)}),this.eventBus.on(de.ERROR,()=>{this.failure=!0,this.eventBus.emit(F.FAILED)}),this.eventBus.on(_.CONNECTED,()=>{this.pollProcessor.stop()}),this.eventBus.on(_.DISCONNECTED,()=>{this.closing||this.pollProcessor.start()});for(let e of Object.values(D))this.eventBus.on(e,t=>{switch(e){case D.FLAG_STORED:case D.FLAG_DELETED:this.eventBus.emit(F.CHANGED,t);break;case D.SEGMENT_STORED:case D.SEGMENT_DELETED:this.repository.findFlagsBySegment(t).then(i=>{i.forEach(n=>this.eventBus.emit(F.CHANGED,n))});break}})}on(e,t){let i=[];for(let n of Object.values(F))i.push(n);i.includes(e)&&this.eventBus.on(e,t)}off(e,t){e?this.eventBus.off(e,t):this.close()}async authenticate(){try{let e=await this.api.authenticate({apiKey:this.sdkKey});this.authToken=e.data.authToken,this.configuration.accessToken=this.authToken;let t=(0,dr.default)(this.authToken);this.environment=t.environment,this.cluster=t.clusterIdentifier||"1"}catch(e){this.failure=!0,console.error("Error while authenticating, err: ",e)}}waitForInitialization(){return this.waitForInitialize?this.waitForInitialize:(this.initialized?this.waitForInitialize=Promise.resolve(this):this.failure?this.waitForInitialize=Promise.reject(this.failure):this.waitForInitialize=new Promise((e,t)=>{this.eventBus.once(F.READY,()=>{e(this)}),this.eventBus.once(F.FAILED,t)}),this.waitForInitialize)}initialize(e){switch(e){case 0:this.pollerReady=!0,this.log.debug("PollingProcessor ready");break;case 1:this.streamReady=!0,this.log.debug("StreamingProcessor ready");break;case 2:this.metricReady=!0,this.log.debug("MetricsProcessor ready");break}this.options.enableStream&&!this.streamReady||this.options.enableAnalytics&&!this.metricReady||!this.pollerReady||(this.initialized=!0,this.eventBus.emit(F.READY))}async run(){await this.authenticate(),this.pollProcessor=new Xe(this.environment,this.cluster,this.api,this.options,this.eventBus,this.repository),this.pollProcessor.start(),this.options.enableStream&&(this.streamProcessor=new Fe(this.api,this.sdkKey,this.environment,this.authToken,this.options,this.cluster,this.eventBus,this.repository),this.streamProcessor.start()),this.options.enableAnalytics&&(this.metricsProcessor=pr(this.environment,this.cluster,this.configuration,this.options,this.eventBus),this.metricsProcessor.start()),this.log.info("finished setting up processors")}boolVariation(e,t,i=!1){return this.evaluator.boolVariation(e,t,i,(n,s,a)=>{this.metricsProcessor&&this.metricsProcessor.enqueue(s,n,a)})}stringVariation(e,t,i=""){return this.evaluator.stringVariation(e,t,i,(n,s,a)=>{this.metricsProcessor&&this.metricsProcessor.enqueue(s,n,a)})}numberVariation(e,t,i=0){return this.evaluator.numberVariation(e,t,i,(n,s,a)=>{this.metricsProcessor&&this.metricsProcessor.enqueue(s,n,a)})}jsonVariation(e,t,i={}){return this.evaluator.jsonVariation(e,t,i,(n,s,a)=>{this.metricsProcessor&&this.metricsProcessor.enqueue(s,n,a)})}close(){this.closing=!0,this.pollProcessor.close(),this.streamProcessor&&this.streamProcessor.close(),this.metricsProcessor&&this.metricsProcessor.close(),this.eventBus.removeAllListeners(),this.closing=!1}};var di=ge(it());var fs={instance:void 0,init:function(r,e){this.instance||(this.instance=new Le(r,e))},waitForInitialization:function(){return this.instance.waitForInitialization()},boolVariation:function(r,e,t=!1){return this.instance.boolVariation(r,e,t)},stringVariation:function(r,e,t=""){return this.instance.stringVariation(r,e,t)},numberVariation:function(r,e,t=0){return this.instance.numberVariation(r,e,t)},jsonVariation:function(r,e,t=""){return this.instance.jsonVariation(r,e,t)},on:function(r,e){this.instance.on(r,e)},off:function(r,e){this.instance.off(r,e)},close:function(){return this.instance.close()}};var export_LRU=di.default;export{Le as Client,F as Event,Ue as FileStore,export_LRU as LRU,fs as default};
//# sourceMappingURL=index.mjs.map
